---
title: "ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ä¸­èº«ã‚’ã®ãã„ãŸã‚‰ã€ã¨ã¦ã‚‚å‹‰å¼·ã«ãªã£ãŸã€jotaiã€‘"
emoji: "ğŸ¦"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["JavaScript", "TypeScript", "React", "Next.js", "jotai"]
published: false
publication_name: "gohan_dao"
---

# jotai ã¨ã„ã†ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã”å­˜çŸ¥ã§ã—ã‚‡ã†ã‹ï¼Ÿ

jotai ã¯çŠ¶æ…‹ç®¡ç†ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã™ã€‚
ä½¿ã„æ–¹ã¯ã¨ã¦ã‚‚ç°¡å˜ã€‚

```bash
yarn add jotai
```

```ts: user.state.ts
import { atom } from "jotai";

const userAtom = atom({
  name: "John",
  age: 20,
});
```

ã“ã‚Œã ã‘ã§ãƒ•ãƒƒã‚¯ã‚¹ãƒ©ã‚¤ã‚¯ã«çŠ¶æ…‹ã‚’ç®¡ç†ã§ãã¾ã™ã€‚

å‘¼ã³å‡ºã—æ–¹ã¯ã“ã‚“ãªæ„Ÿã˜ã€‚

```tsx: user.tsx
import { useAtom } from "jotai";
const User = () => {
  const [user, setUser] = useAtom(userAtom);
  return (
    <div>
      <p>{user.name}</p>
      <p>{user.age}</p>
    </div>
  );
};
```

è©³ã—ã„ jotai ã®ä½¿ã„ã‹ãŸã¯ã€[ã“ã¡ã‚‰](https://zenn.dev/gohan_dao/articles/0ad232f0269fe1)ã«è¨˜äº‹ã‚’æ›¸ã„ãŸã®ã§ã€ã”è¦§ãã ã•ã„ã€‚

ãªãœã“ã®ã‚ˆã†ã«å‹•ä½œã—ã¦ã„ã‚‹ã®ã‹ã¨ã„ã†ã¨`jotai`ã¨ã„ã†ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒ`atom`ã‚„`useAtom`ã‚’æä¾›ã—ã¦ã„ã‚‹ã‹ã‚‰ã§ã™ã€‚

# ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ä¸­ã‚’ã®ãã„ã¦ã¿ã‚‹

`node_modules`ã®ä¸­ã«`jotai`ã¨ã„ã†ãƒ•ã‚©ãƒ«ãƒ€ãŒã‚ã‚Šã¾ã™ã€‚ãŒãã“ã‚’ã¿ã¦ã‚‚çµæ§‹ã‚€ãšã‹ã—ãã€ç†è§£ã—é›£ã„ã§ã™ã€‚

jotai ã®é–‹ç™ºè€…ã®æ–¹ãŒã‚³ã‚¢æ©Ÿèƒ½ã‚’ç°¡å˜ã«å®Ÿè£…ã—ã¦ãã ã•ã£ã¦ã„ã‚‹ã®ã§ã€ãã¡ã‚‰ã‚’ã¿ã¦ã¿ã¾ã—ã‚‡ã†

https://zenn.dev/dai_shi/articles/610a8a958fc9d1

:::details jotai.js

```js jotai.js
const atom = (initialValue) => ({ init: initialValue });

const atomStateMap = new WeakMap();
const getAtomState = (atom) => {
  let atomState = atomStateMap.get(atom);
  if (!atomState) {
    atomState = { value: atom.init, listeners: new Set() };
    atomStateMap.set(atom, atomState);
  }
  return atomState;
};

const useAtom = (atom) => {
  const atomState = getAtomState(atom);
  const [value, setValue] = useState(atomState.value);
  useEffect(() => {
    const callback = () => setValue(atomState.value);
    atomState.listeners.add(callback);
    callback();
    return () => atomState.listeners.delete(callback);
  }, [atomState]);
  const setAtom = (nextValue) => {
    atomState.value = nextValue;
    atomState.listeners.forEach((l) => l());
  };
  return [value, setAtom];
};
```

:::

ç°¡å˜ã®ãŸã‚`TUser`ã¨ã„ã†å‹ã‚’å®šç¾©ã—ã¦ã€ä¸Šè¨˜ã‚’ typescript ã§æ›¸ãç›´ã—ã¦ã¿ã¾ã™ã€‚(å‹ãŒãªã„ã¨èª­ã¿ã¥ã‚‰ã„ã®ã§)

:::message
å®Ÿéš›ã«ã¯å‘¼ã³å‡ºã—å´ã§ã‚‚é™çš„ã«å‹ã‚’ã¤ã‘ã‚Œã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ãŒã€ãªã‹ãªã‹è¤‡é›‘ã«å‹ãŒæ›¸ã„ã¦ã‚ã‚‹ã®ã§ã€ä»Šå›ã¯`TUser`ã®ã¿è¨±å¯ã™ã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚
:::

```ts
type TUser = {
  name: string;
  age: number;
};
```

```tsx: jotai.tsx
import { useState, useEffect } from 'react';

export const atom = (initialValue: TUser) => ({
  init: initialValue,
});

const atomStateMap = new WeakMap<
  { init: TUser },
  { value: TUser; listeners: Set<() => void> }
>();
export const getAtomState = (atom: { init: TUser }) => {
  let atomState = atomStateMap.get(atom);
  if (!atomState) {
    atomState = { value: atom.init, listeners: new Set<() => void>() };
    atomStateMap.set(atom, atomState);
  }
  return atomState;
};

export const useAtom = (atom: { init: TUser }) => {
  const atomState = getAtomState(atom);
  const [value, setValue] = useState<TUser>(atomState.value);
  useEffect(() => {
    const callback = () => setValue(atomState.value);
    atomState.listeners.add(callback);
    callback();
    return () => {
      atomState.listeners.delete(callback);
    };
  }, [atomState]);
  const setAtom = (nextValue: TUser) => {
    atomState.value = nextValue;
    atomState.listeners.forEach((l: () => void) => l());
  };
  return [value, setAtom] as const;
};

```

ã“ã‚Œã§æº–å‚™å®Œäº†ã§ã™ã€‚

# ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’è¿½ã£ã¦ã„ã

## atom

ä¸Šã‹ã‚‰é †ã«èª­ã‚“ã§ã„ãã¾ã™ã€‚
åˆã‚ã«`atom`ã¨ã„ã†é–¢æ•°ã‚’å®šç¾©ã—ã¦ã„ã¾ã™ã€‚æˆ»ã‚Šå€¤ã¯`{ init: TUser }`ã¨ã„ã†å‹ã§ã™ã€‚

```tsx: jotai.tsx
export const atom = (initialValue: TUser): { init: TUser } => ({
  init: initialValue,
});
```

å‘¼ã³å‡ºã—å´ã§ã¯`atom`ã‚’ä½¿ã£ã¦`userAtom`ã‚’å®šç¾©ã—ã¦ã„ã¾ã™ã€‚

```tsx: user.tsx
const userAtom = atom({
  name: "John",
  age: 20,
});

// userAtom = { init: { name: "John", age: 20 } }
```

ã“ã‚ŒãŒåˆæœŸå€¤ã«ãªã‚Šã¾ã™ã€‚

## atomStateMap

`atomStateMap`ã«ã¯`WeakMap`ã‚’ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–ã—ãŸã‚‚ã®ãŒå…¥ã£ã¦ã„ã¾ã™ã€‚

```tsx: jotai.tsx
const atomStateMap = new WeakMap<
  { init: TUser },
  { value: TUser; listeners: Set<() => void> }
>();
```

`WeakMap`ã¯ã‚ã¾ã‚Šé¦´æŸ“ã¿ãŒãªã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ãŒã€ç°¡å˜ãªä½¿ã„æ–¹ã ã‘ã®ã—ã¦ãŠãã¾ã™ã€‚
:::details index.js

```js
const test = {}; // ã‚­ãƒ¼ã¯ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ã¿
const wm = new WeakMap(); // WeakMapã‚’ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–
wm.set(test, "hoge"); // ã‚­ãƒ¼:testã€ãƒãƒªãƒ¥ãƒ¼ï¼š"hoge"ã‚’è¨­å®š
console.log(wm.has(test)); // true
console.log(wm.get(test)); // hoge
wm.delete(test); // ã‚­ãƒ¼:testã€ãƒãƒªãƒ¥ãƒ¼ï¼š"hoge"ã‚’å‰Šé™¤
console.log(wm.has(test)); // false
```

:::
è©³ã—ã„èª¬æ˜ã¯æœ¬é¡Œã‹ã‚‰å¤–ã‚Œã‚‹ã®ã§ã€ã“ã“ã§ã¯å‰²æ„›ã—ã¾ã™ã€‚

Map ã¨ã®æœ€åˆã®é•ã„ã¯ã€WeakMap ã®ã‚­ãƒ¼ã¯ãƒ—ãƒªãƒŸãƒ†ã‚£ãƒ–ãªå€¤ã§ã¯ãªãã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã§ãªã‘ã‚Œã°ãªã‚‰ãªã„ã“ã¨ã§ã™:

https://developer.mozilla.org/ja/docs/Web/JavaScript/Reference/Global_Objects/WeakMap

ã“ã“ã§ã¯ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–ã—ã¦ã„ã‚‹ã®ã¿ã§ã™ã®ã§ã€ç‰¹ã«èª¬æ˜ã—ã¦ãŠãã“ã¨ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚

## getAtomState

```tsx
export const getAtomState = (atom: {
  init: TUser;
}): { value: TUser; listeners: Set<() => void> } => {
  let atomState = atomStateMap.get(atom);
  if (!atomState) {
    atomState = { value: atom.init, listeners: new Set<() => void>() };
    atomStateMap.set(atom, atomState);
  }
  return atomState;
};
```

ã“ã®é–¢æ•°ã¯å‹é€šã‚Šã«`atom`ã‚’å¼•æ•°ã«å–ã‚Šã€`atomState`ã‚’è¿”ã—ã¾ã™ã€‚
ã“ã®é–¢æ•°ã¯æ¡ä»¶åˆ†å²ãŒã‚ã‚‹ã®ã§ã€ï¼’ãƒ‘ã‚¿ãƒ¼ãƒ³ã«åˆ†ã‘ã¦ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’è¿½ã£ã¦ã„ãã¾ã™ã€‚

### atomState ãŒå­˜åœ¨ã™ã‚‹å ´åˆ(if ã®æ¡ä»¶ãŒ false ã®å ´åˆ)

`atomState`ãŒå­˜åœ¨ã™ã‚‹ã¨ã„ã†ã“ã¨ã¯ã€`atomStateMap`ã«`atom`ãŒå­˜åœ¨ã™ã‚‹ã¨ã„ã†ã“ã¨ã§ã™ã€‚  
ãã®å ´åˆã€if åˆ†ã«å…¥ã‚‰ãšã«`atomState`ã‚’è¿”ã—ã¾ã™ã€‚

### atomState ãŒå­˜åœ¨ã—ãªã„å ´åˆ(if ã®æ¡ä»¶ãŒ true ã®å ´åˆ)

`atomState`ãŒå­˜åœ¨ã—ãªã„ã¨ã„ã†ã“ã¨ã¯ã€`atomStateMap`ã«`atom`ãŒå­˜åœ¨ã—ãªã„ã¨ã„ã†ã“ã¨ã§ã™ã€‚
ãã®å ´åˆã€if åˆ†ã«å…¥ã‚Šã€`atomState`ã‚’ä½œæˆã—ã¾ã—ã€`atomStateMap`ã®ã‚­ãƒ¼ã«`atom`ã€ãƒãƒªãƒ¥ãƒ¼ã«`atomState`ã‚’è¨­å®šã—ã¾ã™ã€‚

## useAtom

æœ€å¾Œã«`useAtom`ã‚’è¦‹ã¦ã„ãã¾ã™ã€‚

ãã®å‰ã«`Set`ã«ã¤ã„ã¦èª¬æ˜ã—ã¦ãŠãã¾ã™ã€‚

Set ã¯ JavaScript ã®çµ„ã¿è¾¼ã¿ API ã®ã²ã¨ã¤ã§ã€å€¤ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’æ‰±ã†ãŸã‚ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã§ã™ã€‚Set ã«ã¯é‡è¤‡ã™ã‚‹å€¤ãŒæ ¼ç´ã§ãã¾ã›ã‚“ã€‚Set ã«æ ¼ç´ã•ã‚ŒãŸå€¤ã¯ä¸€æ„(unique)ã«ãªã‚Šã¾ã™ã€‚

:::details index.js

```js
const fruits = new Set(["apple", "orange", "banana"]); //Set(3) { 'apple', 'orange', 'banana' }
fruits.add("strawberry"); //Set(4) { 'apple', 'orange', 'banana', 'strawberry' }
fruits.forEach((value, key) => {});
fruits.delete("apple"); //Set(3) { 'orange', 'banana', 'strawberry' }
fruits.has("apple"); // false
fruits.has("orange"); // true
fruits.clear(); //Set(0) {}
```

ä¸Šè¨˜ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã¯ã€Set ã®åŸºæœ¬çš„ãªä½¿ã„æ–¹ã§ã™ã€‚

# å‚è€ƒ

https://developer.mozilla.org/ja/docs/Web/JavaScript/Reference/Global_Objects/WeakMap
https://typescriptbook.jp/reference/builtin-api/set
